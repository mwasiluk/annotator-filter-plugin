(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e=function(t,e){function n(){this.constructor=t}for(var o in e)i.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},i={}.hasOwnProperty,n=[].slice;Annotator.Plugin.Filter=function(i){function o(e,i){this._onPreviousClick=t(this._onPreviousClick,this),this._onNextClick=t(this._onNextClick,this),this._onBooleanFilterChange=t(this._onBooleanFilterChange,this),this._onFilterKeyup=t(this._onFilterKeyup,this),this._onFilterBlur=t(this._onFilterBlur,this),this._onFilterFocus=t(this._onFilterFocus,this),this.updateHighlights=t(this.updateHighlights,this),this.publishFilteredEvent=t(this.publishFilteredEvent,this),this.updateFilters=t(this.updateFilters,this);var n;e=$(this.html.element).appendTo((null!=i?i.appendTo:void 0)||this.options.appendTo),o.__super__.constructor.call(this,e,i),(n=this.options).filters||(n.filters=[]),this.filter=$(this.html.filter),this.filterBoolean=$(this.html.filterBoolean),this.filters=[],this.current=0,this.debouncedOnFilterKeyUp=this.debounce(function(t){var e;return e=$(t.target).parent().data("filter"),e?this.updateFilter(e):void 0},this.options.keyUpDebounce)}return e(o,i),o.prototype.events={".annotator-filter-property input focus":"_onFilterFocus",".annotator-filter-property input blur":"_onFilterBlur",".annotator-filter-property input keyup":"_onFilterKeyup",".annotator-filter-property input[type='checkbox'] change":"_onBooleanFilterChange",".annotator-filter-previous click":"_onPreviousClick",".annotator-filter-next click":"_onNextClick",".annotator-filter-clear click":"_onClearClick"},o.prototype.classes={active:"annotator-filter-active",hl:{hide:"annotator-hl-filtered",active:"annotator-hl-active"}},o.prototype.html={element:'<div class="annotator-filter"></div>',navigation:'<span class="annotator-filter-navigation-wrapper">\n    <strong>'+Annotator._t("Navigate:")+'</strong>\n<span class="annotator-filter-navigation">\n   <button class="annotator-filter-previous">'+Annotator._t("Previous")+'</button>\n<button class="annotator-filter-next">'+Annotator._t("Next")+"</button>\n    </span>\n</span>",filterBy:"<strong>"+Annotator._t("Filter by:")+"</strong>",filter:'<span class="annotator-filter-property">\n  <label></label>\n  <input/>\n  <button class="annotator-filter-clear">'+Annotator._t("Clear")+"</button>\n</span>",filterBoolean:"<span class=\"annotator-filter-property filter-boolean\">\n  <label>\n\n   </label>\n   <input type='checkbox'/>\n</span>"},o.prototype.options={appendTo:"body",insertSpacer:!0,showNavigation:!0,showFilterByLabel:!0,filters:[],addAnnotationFilter:!0,keyUpDebounce:300,idPrefix:"",isFiltered:function(t,e,i){var n,o,r,s,l;if(i)return!!t==!!e;if(!t||!e)return!1;for(s=e.toLowerCase(),l=t.toLowerCase().split(/\s+/),n=0,r=l.length;r>n;n++)if(o=l[n],-1===s.indexOf(o))return!1;return!0}},o.prototype.pluginInit=function(){var t,e,i,n;for(this.options.showNavigation&&$(this.html.navigation).appendTo(this.element),this.options.showFilterByLabel&&$(this.html.filterBy).appendTo(this.element),n=this.options.filters,e=0,i=n.length;i>e;e++)t=n[e],this.addFilter(t);return this.updateHighlights(),this._setupListeners(),this.options.insertSpacer&&this._insertSpacer(),this.options.addAnnotationFilter===!0?this.addFilter({label:Annotator._t("Annotation"),property:"text"}):void 0},o.prototype.destroy=function(){var t,e;return o.__super__.destroy.apply(this,arguments),e=$("html"),t=parseInt(e.css("padding-top"),10)||0,e.css("padding-top",t-this.element.outerHeight()),this.element.remove()},o.prototype._insertSpacer=function(){var t,e;return e=$("html"),t=parseInt(e.css("padding-top"),10)||0,e.css("padding-top",t+this.element.outerHeight()),this},o.prototype._setupListeners=function(){var t,e,i,n,o,r;for(i=["annotationsLoaded","annotationCreated","annotationUpdated","annotationDeleted"],r=this,t=function(){return setTimeout(r.updateFilters,2)},n=0,o=i.length;o>n;n++)e=i[n],this.annotator.subscribe(e,t);return this},o.prototype.addFilter=function(t){var e,i,n;return i=$.extend({label:"",property:"",isFiltered:this.options.isFiltered,isBoolean:!1,isAlwaysActive:!1,enabled:!0},t),i.enabled&&(function(){var t,n,o,r;for(o=this.filters,r=[],t=0,n=o.length;n>t;t++)e=o[t],e.property===i.property&&e.isBoolean===i.isBoolean&&r.push(e);return r}.call(this).length||(i.id=this.options.idPrefix+"annotator-filter-"+i.property,i.isBoolean&&(i.id+="-boolean"),i.name&&(i.id+="-"+i.name),i.annotations=[],i.isBoolean?i.element=this.filterBoolean.clone().appendTo(this.element):i.element=this.filter.clone().appendTo(this.element),i.element.find("label").html(i.label).attr("for",i.id),n=i.element.find("input"),n.attr({id:i.id}),i.isBoolean||(n.attr({placeholder:Annotator._t("Filter by ")+i.label+"â€¦"}),i.element.find("button").hide()),i.element.data("filter",i),this.filters.push(i))),this},o.prototype.updateFilter=function(t){var e,i;return this.updateHighlights(),this.resetHighlights(),i=t.currentInputVal,this.updateFilterState(t),e=t.currentInputVal!==i,e?(this.filterHighlights(),this.publishFilteredEvent()):void 0},o.prototype.updateFilterState=function(t){var e,i,n,o,r,s,l,a,h;if(t.annotations=[],r=t.element.find("input"),o=t.isBoolean?r.is(":checked"):$.trim(r.val()),t.isActive=t.isAlwaysActive||!!o,t.currentInputVal=o,t.isActive){for(i=this.highlights.map(function(){return $(this).data("annotation")}),a=$.makeArray(i),h=[],n=0,s=a.length;s>n;n++)e=a[n],l=e[t.property],t.isFiltered(o,l,t.isBoolean)?h.push(t.annotations.push(e)):h.push(void 0);return h}},o.prototype.updateFilters=function(){var t,e,i,n;for(this.updateHighlights(),this.resetHighlights(),n=this.filters,e=0,i=n.length;i>e;e++)t=n[e],this.updateFilterState(t);return this.filterHighlights()},o.prototype.publishFilteredEvent=function(){var t,e,i,n,o;for(t=$.grep(this.filters,function(t){return t.isActive}),t||(t=[]),e=[],n=0,o=t.length;o>n;n++)i=t[n],e.push({name:i.name,property:i.property,value:i.currentInputVal});return this.annotator.publish("annotationsFiltered",[e]),this},o.prototype.updateHighlights=function(){return this.highlights=this.annotator.element.find(".annotator-hl:visible"),this.filtered=this.highlights.not(this.classes.hl.hide)},o.prototype.filterHighlights=function(){var t,e,i,n,o,r,s,l;if(t=$.grep(this.filters,function(t){return t.isActive}),!t.length)return this;for(i=(null!=(l=t[0])?l.annotations:void 0)||[],t.length>1&&(i=this.intersection(t.map(function(t){return t.annotations}))),console.log(i),n=this.highlights,r=o=0,s=i.length;s>o;r=++o)e=i[r],n=n.not(e.highlights);return n.addClass(this.classes.hl.hide),this.filtered=this.highlights.not(this.classes.hl.hide),this},o.prototype.resetHighlights=function(){return this.highlights.removeClass(this.classes.hl.hide),this.filtered=this.highlights,this},o.prototype._onFilterFocus=function(t){var e;return e=$(t.target),e.parent().addClass(this.classes.active),e.next("button").show()},o.prototype._onFilterBlur=function(t){var e;return t.target.value?void 0:(e=$(t.target),e.parent().removeClass(this.classes.active),e.next("button").hide())},o.prototype._onFilterKeyup=function(t){return this.debouncedOnFilterKeyUp(t)},o.prototype._onBooleanFilterChange=function(t){var e,i,n;return i=$(t.target),e=i.parent().data("filter"),n=i.is(":checked"),n||i.parent().removeClass(this.classes.active),e?this.updateFilter(e):void 0},o.prototype._findNextHighlight=function(t){var e,i,n,o,r,s,l,a;return this.highlights.length?(s=t?0:-1,a=t?-1:0,l=t?"lt":"gt",e=this.highlights.not("."+this.classes.hl.hide),n=e.filter("."+this.classes.hl.active),n.length||(n=e.eq(s)),i=n.data("annotation"),o=e.index(n[0]),r=e.filter(":"+l+"("+o+")").not(i.highlights).eq(a),r.length||(r=e.eq(a)),this._scrollToHighlight(r.data("annotation").highlights)):this},o.prototype._onNextClick=function(t){return this._findNextHighlight()},o.prototype._onPreviousClick=function(t){return this._findNextHighlight(!0)},o.prototype._scrollToHighlight=function(t){return t=$(t),this.highlights.removeClass(this.classes.hl.active),t.addClass(this.classes.hl.active),$("html, body").animate({scrollTop:t.offset().top-(this.element.height()+20)},150)},o.prototype._onClearClick=function(t){return $(t.target).prev("input").val("").keyup().blur()},o.prototype.intersection=function(t){return t.shift().reduce(function(e,i){return-1===e.indexOf(i)&&t.every(function(t){return-1!==t.indexOf(i)})&&e.push(i),e},[])},o.prototype.debounce=function(t,e,i){var o;return o=null,function(){var r,s,l;return r=1<=arguments.length?n.call(arguments,0):[],l=this,s=function(){return i||t.apply(l,r),o=null},o?clearTimeout(o):i&&t.apply(l,r),o=setTimeout(s,e||100)}},o.prototype.throttle=function(t,e,i){var n,o;return e||(e=250),o=void 0,n=void 0,function(){var r,s,l;s=i||this,l=+new Date,r=arguments,o&&o+e>l?(clearTimeout(n),n=setTimeout(function(){o=l,t.apply(s,r)},e)):(o=l,t.apply(s,r))}},o}(Annotator.Plugin)}).call(this);